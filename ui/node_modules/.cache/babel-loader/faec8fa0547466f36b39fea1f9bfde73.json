{"ast":null,"code":"'use strict';\n/*!\n * ignore\n */\n\nconst get = require('../get');\n\nmodule.exports = applyTimestampsToUpdate;\n/*!\n * ignore\n */\n\nfunction applyTimestampsToUpdate(now, createdAt, updatedAt, currentUpdate, options) {\n  const updates = currentUpdate;\n  let _updates = updates;\n  const overwrite = get(options, 'overwrite', false);\n  const timestamps = get(options, 'timestamps', true); // Support skipping timestamps at the query level, see gh-6980\n\n  if (!timestamps || updates == null) {\n    return currentUpdate;\n  }\n\n  const skipCreatedAt = timestamps != null && timestamps.createdAt === false;\n  const skipUpdatedAt = timestamps != null && timestamps.updatedAt === false;\n\n  if (overwrite) {\n    if (currentUpdate && currentUpdate.$set) {\n      currentUpdate = currentUpdate.$set;\n      updates.$set = {};\n      _updates = updates.$set;\n    }\n\n    if (!skipUpdatedAt && updatedAt && !currentUpdate[updatedAt]) {\n      _updates[updatedAt] = now;\n    }\n\n    if (!skipCreatedAt && createdAt && !currentUpdate[createdAt]) {\n      _updates[createdAt] = now;\n    }\n\n    return updates;\n  }\n\n  currentUpdate = currentUpdate || {};\n\n  if (Array.isArray(updates)) {\n    // Update with aggregation pipeline\n    updates.push({\n      $set: {\n        updatedAt: now\n      }\n    });\n    return updates;\n  }\n\n  updates.$set = updates.$set || {};\n\n  if (!skipUpdatedAt && updatedAt && (!currentUpdate.$currentDate || !currentUpdate.$currentDate[updatedAt])) {\n    let timestampSet = false;\n\n    if (updatedAt.indexOf('.') !== -1) {\n      const pieces = updatedAt.split('.');\n\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set && currentUpdate.$set[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n\n    if (!timestampSet) {\n      updates.$set[updatedAt] = now;\n    }\n\n    if (updates.hasOwnProperty(updatedAt)) {\n      delete updates[updatedAt];\n    }\n  }\n\n  if (!skipCreatedAt && createdAt) {\n    if (currentUpdate[createdAt]) {\n      delete currentUpdate[createdAt];\n    }\n\n    if (currentUpdate.$set && currentUpdate.$set[createdAt]) {\n      delete currentUpdate.$set[createdAt];\n    }\n\n    let timestampSet = false;\n\n    if (createdAt.indexOf('.') !== -1) {\n      const pieces = createdAt.split('.');\n\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set && currentUpdate.$set[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n\n    if (!timestampSet) {\n      updates.$setOnInsert = updates.$setOnInsert || {};\n      updates.$setOnInsert[createdAt] = now;\n    }\n  }\n\n  if (Object.keys(updates.$set).length === 0) {\n    delete updates.$set;\n  }\n\n  return updates;\n}","map":{"version":3,"sources":["/home/gregorian/calendar-ui/node_modules/mongoose/lib/helpers/update/applyTimestampsToUpdate.js"],"names":["get","require","module","exports","applyTimestampsToUpdate","now","createdAt","updatedAt","currentUpdate","options","updates","_updates","overwrite","timestamps","skipCreatedAt","skipUpdatedAt","$set","Array","isArray","push","$currentDate","timestampSet","indexOf","pieces","split","i","length","remnant","slice","join","start","hasOwnProperty","$setOnInsert","Object","keys"],"mappings":"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","sourcesContent":["'use strict';\n\n/*!\n * ignore\n */\n\nconst get = require('../get');\n\nmodule.exports = applyTimestampsToUpdate;\n\n/*!\n * ignore\n */\n\nfunction applyTimestampsToUpdate(now, createdAt, updatedAt, currentUpdate, options) {\n  const updates = currentUpdate;\n  let _updates = updates;\n  const overwrite = get(options, 'overwrite', false);\n  const timestamps = get(options, 'timestamps', true);\n\n  // Support skipping timestamps at the query level, see gh-6980\n  if (!timestamps || updates == null) {\n    return currentUpdate;\n  }\n\n  const skipCreatedAt = timestamps != null && timestamps.createdAt === false;\n  const skipUpdatedAt = timestamps != null && timestamps.updatedAt === false;\n\n  if (overwrite) {\n    if (currentUpdate && currentUpdate.$set) {\n      currentUpdate = currentUpdate.$set;\n      updates.$set = {};\n      _updates = updates.$set;\n    }\n    if (!skipUpdatedAt && updatedAt && !currentUpdate[updatedAt]) {\n      _updates[updatedAt] = now;\n    }\n    if (!skipCreatedAt && createdAt && !currentUpdate[createdAt]) {\n      _updates[createdAt] = now;\n    }\n    return updates;\n  }\n  currentUpdate = currentUpdate || {};\n\n  if (Array.isArray(updates)) {\n    // Update with aggregation pipeline\n    updates.push({ $set: { updatedAt: now } });\n\n    return updates;\n  }\n\n  updates.$set = updates.$set || {};\n  if (!skipUpdatedAt && updatedAt &&\n      (!currentUpdate.$currentDate || !currentUpdate.$currentDate[updatedAt])) {\n    let timestampSet = false;\n    if (updatedAt.indexOf('.') !== -1) {\n      const pieces = updatedAt.split('.');\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set && currentUpdate.$set[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n\n    if (!timestampSet) {\n      updates.$set[updatedAt] = now;\n    }\n\n    if (updates.hasOwnProperty(updatedAt)) {\n      delete updates[updatedAt];\n    }\n  }\n\n  if (!skipCreatedAt && createdAt) {\n\n    if (currentUpdate[createdAt]) {\n      delete currentUpdate[createdAt];\n    }\n    if (currentUpdate.$set && currentUpdate.$set[createdAt]) {\n      delete currentUpdate.$set[createdAt];\n    }\n    let timestampSet = false;\n    if (createdAt.indexOf('.') !== -1) {\n      const pieces = createdAt.split('.');\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set && currentUpdate.$set[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n\n    if (!timestampSet) {\n      updates.$setOnInsert = updates.$setOnInsert || {};\n      updates.$setOnInsert[createdAt] = now;\n    }\n  }\n\n  if (Object.keys(updates.$set).length === 0) {\n    delete updates.$set;\n  }\n  return updates;\n}\n"]},"metadata":{},"sourceType":"script"}