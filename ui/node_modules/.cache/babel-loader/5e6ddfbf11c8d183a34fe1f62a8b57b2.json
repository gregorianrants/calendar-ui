{"ast":null,"code":"'use strict';\n\nconst applyTimestampsToChildren = require('../update/applyTimestampsToChildren');\n\nconst applyTimestampsToUpdate = require('../update/applyTimestampsToUpdate');\n\nconst get = require('../get');\n\nconst handleTimestampOption = require('../schema/handleTimestampOption');\n\nconst symbols = require('../../schema/symbols');\n\nmodule.exports = function setupTimestamps(schema, timestamps) {\n  const childHasTimestamp = schema.childSchemas.find(withTimestamp);\n\n  function withTimestamp(s) {\n    const ts = s.schema.options.timestamps;\n    return !!ts;\n  }\n\n  if (!timestamps && !childHasTimestamp) {\n    return;\n  }\n\n  const createdAt = handleTimestampOption(timestamps, 'createdAt');\n  const updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n  const currentTime = timestamps != null && timestamps.hasOwnProperty('currentTime') ? timestamps.currentTime : null;\n  const schemaAdditions = {};\n  schema.$timestamps = {\n    createdAt: createdAt,\n    updatedAt: updatedAt\n  };\n\n  if (updatedAt && !schema.paths[updatedAt]) {\n    schemaAdditions[updatedAt] = Date;\n  }\n\n  if (createdAt && !schema.paths[createdAt]) {\n    schemaAdditions[createdAt] = {\n      type: Date,\n      immutable: true\n    };\n  }\n\n  schema.add(schemaAdditions);\n  schema.pre('save', function (next) {\n    const timestampOption = get(this, '$__.saveOptions.timestamps');\n\n    if (timestampOption === false) {\n      return next();\n    }\n\n    const skipUpdatedAt = timestampOption != null && timestampOption.updatedAt === false;\n    const skipCreatedAt = timestampOption != null && timestampOption.createdAt === false;\n    const defaultTimestamp = currentTime != null ? currentTime() : (this.ownerDocument ? this.ownerDocument() : this).constructor.base.now();\n    const auto_id = this._id && this._id.auto;\n\n    if (!skipCreatedAt && createdAt && !this.$__getValue(createdAt) && this.$__isSelected(createdAt)) {\n      this.$set(createdAt, auto_id ? this._id.getTimestamp() : defaultTimestamp);\n    }\n\n    if (!skipUpdatedAt && updatedAt && (this.isNew || this.$isModified())) {\n      let ts = defaultTimestamp;\n\n      if (this.isNew) {\n        if (createdAt != null) {\n          ts = this.$__getValue(createdAt);\n        } else if (auto_id) {\n          ts = this._id.getTimestamp();\n        }\n      }\n\n      this.$set(updatedAt, ts);\n    }\n\n    next();\n  });\n\n  schema.methods.initializeTimestamps = function () {\n    const ts = currentTime != null ? currentTime() : this.constructor.base.now();\n\n    if (createdAt && !this.get(createdAt)) {\n      this.$set(createdAt, ts);\n    }\n\n    if (updatedAt && !this.get(updatedAt)) {\n      this.$set(updatedAt, ts);\n    }\n\n    return this;\n  };\n\n  _setTimestampsOnUpdate[symbols.builtInMiddleware] = true;\n  const opts = {\n    query: true,\n    model: false\n  };\n  schema.pre('findOneAndReplace', opts, _setTimestampsOnUpdate);\n  schema.pre('findOneAndUpdate', opts, _setTimestampsOnUpdate);\n  schema.pre('replaceOne', opts, _setTimestampsOnUpdate);\n  schema.pre('update', opts, _setTimestampsOnUpdate);\n  schema.pre('updateOne', opts, _setTimestampsOnUpdate);\n  schema.pre('updateMany', opts, _setTimestampsOnUpdate);\n\n  function _setTimestampsOnUpdate(next) {\n    const now = currentTime != null ? currentTime() : this.model.base.now(); // Replacing with null update should still trigger timestamps\n\n    if (this.op === 'findOneAndReplace' && this.getUpdate() == null) {\n      this.setUpdate({});\n    }\n\n    applyTimestampsToUpdate(now, createdAt, updatedAt, this.getUpdate(), this.options, this.schema);\n    applyTimestampsToChildren(now, this.getUpdate(), this.model.schema);\n    next();\n  }\n};","map":{"version":3,"sources":["/home/gregorian/calendar-ui/node_modules/mongoose/lib/helpers/timestamps/setupTimestamps.js"],"names":["applyTimestampsToChildren","require","applyTimestampsToUpdate","get","handleTimestampOption","symbols","module","exports","setupTimestamps","schema","timestamps","childHasTimestamp","childSchemas","find","withTimestamp","s","ts","options","createdAt","updatedAt","currentTime","hasOwnProperty","schemaAdditions","$timestamps","paths","Date","type","immutable","add","pre","next","timestampOption","skipUpdatedAt","skipCreatedAt","defaultTimestamp","ownerDocument","constructor","base","now","auto_id","_id","auto","$__getValue","$__isSelected","$set","getTimestamp","isNew","$isModified","methods","initializeTimestamps","_setTimestampsOnUpdate","builtInMiddleware","opts","query","model","op","getUpdate","setUpdate"],"mappings":"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","sourcesContent":["'use strict';\n\nconst applyTimestampsToChildren = require('../update/applyTimestampsToChildren');\nconst applyTimestampsToUpdate = require('../update/applyTimestampsToUpdate');\nconst get = require('../get');\nconst handleTimestampOption = require('../schema/handleTimestampOption');\nconst symbols = require('../../schema/symbols');\n\nmodule.exports = function setupTimestamps(schema, timestamps) {\n  const childHasTimestamp = schema.childSchemas.find(withTimestamp);\n  function withTimestamp(s) {\n    const ts = s.schema.options.timestamps;\n    return !!ts;\n  }\n\n  if (!timestamps && !childHasTimestamp) {\n    return;\n  }\n\n  const createdAt = handleTimestampOption(timestamps, 'createdAt');\n  const updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n  const currentTime = timestamps != null && timestamps.hasOwnProperty('currentTime') ?\n    timestamps.currentTime :\n    null;\n  const schemaAdditions = {};\n\n  schema.$timestamps = { createdAt: createdAt, updatedAt: updatedAt };\n\n  if (updatedAt && !schema.paths[updatedAt]) {\n    schemaAdditions[updatedAt] = Date;\n  }\n\n  if (createdAt && !schema.paths[createdAt]) {\n    schemaAdditions[createdAt] = { type: Date, immutable: true };\n  }\n  schema.add(schemaAdditions);\n\n  schema.pre('save', function(next) {\n    const timestampOption = get(this, '$__.saveOptions.timestamps');\n    if (timestampOption === false) {\n      return next();\n    }\n\n    const skipUpdatedAt = timestampOption != null && timestampOption.updatedAt === false;\n    const skipCreatedAt = timestampOption != null && timestampOption.createdAt === false;\n\n    const defaultTimestamp = currentTime != null ?\n      currentTime() :\n      (this.ownerDocument ? this.ownerDocument() : this).constructor.base.now();\n    const auto_id = this._id && this._id.auto;\n\n    if (!skipCreatedAt && createdAt && !this.$__getValue(createdAt) && this.$__isSelected(createdAt)) {\n      this.$set(createdAt, auto_id ? this._id.getTimestamp() : defaultTimestamp);\n    }\n\n    if (!skipUpdatedAt && updatedAt && (this.isNew || this.$isModified())) {\n      let ts = defaultTimestamp;\n      if (this.isNew) {\n        if (createdAt != null) {\n          ts = this.$__getValue(createdAt);\n        } else if (auto_id) {\n          ts = this._id.getTimestamp();\n        }\n      }\n      this.$set(updatedAt, ts);\n    }\n\n    next();\n  });\n\n  schema.methods.initializeTimestamps = function() {\n    const ts = currentTime != null ?\n      currentTime() :\n      this.constructor.base.now();\n    if (createdAt && !this.get(createdAt)) {\n      this.$set(createdAt, ts);\n    }\n    if (updatedAt && !this.get(updatedAt)) {\n      this.$set(updatedAt, ts);\n    }\n    return this;\n  };\n\n  _setTimestampsOnUpdate[symbols.builtInMiddleware] = true;\n\n  const opts = { query: true, model: false };\n  schema.pre('findOneAndReplace', opts, _setTimestampsOnUpdate);\n  schema.pre('findOneAndUpdate', opts, _setTimestampsOnUpdate);\n  schema.pre('replaceOne', opts, _setTimestampsOnUpdate);\n  schema.pre('update', opts, _setTimestampsOnUpdate);\n  schema.pre('updateOne', opts, _setTimestampsOnUpdate);\n  schema.pre('updateMany', opts, _setTimestampsOnUpdate);\n\n  function _setTimestampsOnUpdate(next) {\n    const now = currentTime != null ?\n      currentTime() :\n      this.model.base.now();\n    // Replacing with null update should still trigger timestamps\n    if (this.op === 'findOneAndReplace' && this.getUpdate() == null) {\n      this.setUpdate({});\n    }\n    applyTimestampsToUpdate(now, createdAt, updatedAt, this.getUpdate(),\n      this.options, this.schema);\n    applyTimestampsToChildren(now, this.getUpdate(), this.model.schema);\n    next();\n  }\n};"]},"metadata":{},"sourceType":"script"}