{"ast":null,"code":"const mongoose = require(\"mongoose\");\n\nconst cuid = require(\"cuid\");\n/*const addGcalEvent = require('./../googleCalendar')*/\n\n\nconst validator = require(\"validator\"); //todo can we inmport only a subset\n\n\nconst setHours = require(\"date-fns/setHours\");\n\nconst {\n  nextDay\n} = require(\"date-fns\");\n\nconst addressObj = {\n  _id: {\n    type: String,\n    default: cuid\n  },\n  value: {\n    validate: {\n      validator: v => {\n        return v.length > 4;\n      },\n      message: `name must have more than 4 characters`\n    },\n    type: String\n  }\n};\nconst addressSchema = mongoose.Schema(addressObj);\nconst operativeObj = {\n  _id: {\n    type: String,\n    default: cuid\n  },\n  value: {\n    validate: {\n      validator: v => {\n        return v.length > 3;\n      },\n      message: `operative must have more than 3 characters`\n    },\n    type: String\n  }\n};\nconst operativeSchema = mongoose.Schema(operativeObj);\nconst chargesObj = {\n  hourlyRate: {\n    type: Number\n  },\n  fuelCharge: {\n    type: Number\n  },\n  travelTime: {\n    type: Number\n  }\n};\nconst chargesSchema = mongoose.Schema(chargesObj);\nconst customerObj = {\n  name: {\n    type: String,\n    required: true,\n    validate: [{\n      validator: v => {\n        return v.length > 4;\n      },\n      message: `name must have more than 4 characters`\n    }]\n  },\n  mobile: {\n    type: String,\n    validate: {\n      validator: validator.isMobilePhone,\n      //TODO restrict this to uk and have anohter field for other phone numbers.\n      message: `name must have more than 4 characters`\n    }\n  },\n  email: {\n    type: String,\n    validate: {\n      validator: validator.isEmail,\n      message: \"must be a valid email\"\n    }\n  }\n};\nconst customerSchema = mongoose.Schema(customerObj);\nconst jobSchema = new mongoose.Schema({\n  _id: {\n    type: String,\n    default: cuid\n  },\n  start: {\n    type: Date,\n    required: true\n  },\n  end: {\n    type: Date,\n    required: true\n  },\n  customer: customerSchema,\n  charges: chargesSchema,\n  operatives: [operativeSchema],\n  items: String,\n  addresses: [addressSchema],\n  markCompleted: Boolean\n});\n\nfunction validateAsCompleted(doc) {\n  if (doc.markCompleted) {}\n}\n\njobSchema.pre(\"validate\", () => {\n  console.log(this.customer.name);\n  console.log(\"hellpoe\");\n  next();\n});\nlet Job = mongoose.model(\"Job\", jobSchema, \"jobs\");\n\nasync function list({\n  from,\n  to\n}) {\n  let data = await Job.find({\n    start: {\n      $gte: from\n    },\n    end: {\n      $lte: to\n    }\n  });\n  return data;\n}\n\nasync function create(data) {\n  let job = new Job(data);\n  await job.save(); //TODO add some validation start must be before end\n\n  return job;\n}\n\nasync function get(id) {\n  const job = await Job.findById(id);\n  return job;\n}\n\nasync function remove(id) {\n  let data = await Job.deleteOne({\n    _id: id\n  });\n  return data;\n}\n\nasync function edit(_id, change) {\n  // let job = await Job.findByIdAndUpdate(_id, change, {\n  //   new: true,\n  //   runValidators: true,\n  // });\n  // return job;\n  const job = await get(_id);\n  Object.keys(change).forEach(function (key) {\n    job[key] = change[key];\n  });\n  await job.save();\n  return job;\n}\n\nasync function resetData(data) {\n  await Job.deleteMany();\n  console.log(data);\n  await Job.insertMany(data);\n}\n\nmodule.exports = {\n  list,\n  create,\n  get,\n  remove,\n  resetData,\n  edit,\n  jobSchema\n};\nexports.Job = Job;","map":{"version":3,"sources":["/home/gregorian/calendar-ui/api/model/job.js"],"names":["mongoose","require","cuid","validator","setHours","nextDay","addressObj","_id","type","String","default","value","validate","v","length","message","addressSchema","Schema","operativeObj","operativeSchema","chargesObj","hourlyRate","Number","fuelCharge","travelTime","chargesSchema","customerObj","name","required","mobile","isMobilePhone","email","isEmail","customerSchema","jobSchema","start","Date","end","customer","charges","operatives","items","addresses","markCompleted","Boolean","validateAsCompleted","doc","pre","console","log","next","Job","model","list","from","to","data","find","$gte","$lte","create","job","save","get","id","findById","remove","deleteOne","edit","change","Object","keys","forEach","key","resetData","deleteMany","insertMany","module","exports"],"mappings":"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","sourcesContent":["const mongoose = require(\"mongoose\");\nconst cuid = require(\"cuid\");\n/*const addGcalEvent = require('./../googleCalendar')*/\nconst validator = require(\"validator\"); //todo can we inmport only a subset\n\nconst setHours = require(\"date-fns/setHours\");\nconst { nextDay } = require(\"date-fns\");\n\nconst addressObj = {\n  _id: {\n    type: String,\n    default: cuid,\n  },\n  value: {\n    validate: {\n      validator: (v) => {\n        return v.length > 4;\n      },\n      message: `name must have more than 4 characters`,\n    },\n    type: String,\n  },\n};\n\nconst addressSchema = mongoose.Schema(addressObj);\n\nconst operativeObj = {\n  _id: {\n    type: String,\n    default: cuid,\n  },\n  value: {\n    validate: {\n      validator: (v) => {\n        return v.length > 3;\n      },\n      message: `operative must have more than 3 characters`,\n    },\n    type: String,\n  },\n};\n\nconst operativeSchema = mongoose.Schema(operativeObj);\n\nconst chargesObj = {\n  hourlyRate: { type: Number },\n  fuelCharge: { type: Number },\n  travelTime: { type: Number },\n};\n\nconst chargesSchema = mongoose.Schema(chargesObj);\n\nconst customerObj = {\n  name: {\n    type: String,\n    required: true,\n    validate: [\n      {\n        validator: (v) => {\n          return v.length > 4;\n        },\n        message: `name must have more than 4 characters`,\n      },\n    ],\n  },\n  mobile: {\n    type: String,\n    validate: {\n      validator: validator.isMobilePhone, //TODO restrict this to uk and have anohter field for other phone numbers.\n      message: `name must have more than 4 characters`,\n    },\n  },\n  email: {\n    type: String,\n    validate: {\n      validator: validator.isEmail,\n      message: \"must be a valid email\",\n    },\n  },\n};\n\nconst customerSchema = mongoose.Schema(customerObj);\n\nconst jobSchema = new mongoose.Schema({\n  _id: {\n    type: String,\n    default: cuid,\n  },\n  start: {\n    type: Date,\n    required: true,\n  },\n  end: {\n    type: Date,\n    required: true,\n  },\n  customer: customerSchema,\n  charges: chargesSchema,\n  operatives: [operativeSchema],\n  items: String,\n  addresses: [addressSchema],\n  markCompleted: Boolean,\n});\n\nfunction validateAsCompleted(doc) {\n  if (doc.markCompleted) {\n  }\n}\n\njobSchema.pre(\"validate\", () => {\n  console.log(this.customer.name);\n  console.log(\"hellpoe\");\n  next();\n});\n\nlet Job = mongoose.model(\"Job\", jobSchema, \"jobs\");\n\nasync function list({ from, to }) {\n  let data = await Job.find({\n    start: { $gte: from },\n    end: { $lte: to },\n  });\n  return data;\n}\n\nasync function create(data) {\n  let job = new Job(data);\n  await job.save(); //TODO add some validation start must be before end\n  return job;\n}\n\nasync function get(id) {\n  const job = await Job.findById(id);\n  return job;\n}\n\nasync function remove(id) {\n  let data = await Job.deleteOne({ _id: id });\n  return data;\n}\n\nasync function edit(_id, change) {\n  // let job = await Job.findByIdAndUpdate(_id, change, {\n  //   new: true,\n  //   runValidators: true,\n  // });\n  // return job;\n  const job = await get(_id);\n  Object.keys(change).forEach(function (key) {\n    job[key] = change[key];\n  });\n  await job.save();\n  return job;\n}\n\nasync function resetData(data) {\n  await Job.deleteMany();\n  console.log(data);\n  await Job.insertMany(data);\n}\n\nmodule.exports = {\n  list,\n  create,\n  get,\n  remove,\n  resetData,\n  edit,\n  jobSchema,\n};\n\nexports.Job = Job;\n"]},"metadata":{},"sourceType":"script"}