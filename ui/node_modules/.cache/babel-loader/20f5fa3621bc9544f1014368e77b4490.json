{"ast":null,"code":"'use strict';\n\nfunction Kareem() {\n  this._pres = new Map();\n  this._posts = new Map();\n}\n\nKareem.prototype.execPre = function (name, context, args, callback) {\n  if (arguments.length === 3) {\n    callback = args;\n    args = [];\n  }\n\n  var pres = get(this._pres, name, []);\n  var numPres = pres.length;\n  var numAsyncPres = pres.numAsync || 0;\n  var currentPre = 0;\n  var asyncPresLeft = numAsyncPres;\n  var done = false;\n  var $args = args;\n\n  if (!numPres) {\n    return process.nextTick(function () {\n      callback(null);\n    });\n  }\n\n  var next = function () {\n    if (currentPre >= numPres) {\n      return;\n    }\n\n    var pre = pres[currentPre];\n\n    if (pre.isAsync) {\n      var args = [decorateNextFn(_next), decorateNextFn(function (error) {\n        if (error) {\n          if (done) {\n            return;\n          }\n\n          done = true;\n          return callback(error);\n        }\n\n        if (--asyncPresLeft === 0 && currentPre >= numPres) {\n          return callback(null);\n        }\n      })];\n      callMiddlewareFunction(pre.fn, context, args, args[0]);\n    } else if (pre.fn.length > 0) {\n      var args = [decorateNextFn(_next)];\n\n      var _args = arguments.length >= 2 ? arguments : [null].concat($args);\n\n      for (var i = 1; i < _args.length; ++i) {\n        args.push(_args[i]);\n      }\n\n      callMiddlewareFunction(pre.fn, context, args, args[0]);\n    } else {\n      let maybePromise = null;\n\n      try {\n        maybePromise = pre.fn.call(context);\n      } catch (err) {\n        if (err != null) {\n          return callback(err);\n        }\n      }\n\n      if (isPromise(maybePromise)) {\n        maybePromise.then(() => _next(), err => _next(err));\n      } else {\n        if (++currentPre >= numPres) {\n          if (asyncPresLeft > 0) {\n            // Leave parallel hooks to run\n            return;\n          } else {\n            return process.nextTick(function () {\n              callback(null);\n            });\n          }\n        }\n\n        next();\n      }\n    }\n  };\n\n  next.apply(null, [null].concat(args));\n\n  function _next(error) {\n    if (error) {\n      if (done) {\n        return;\n      }\n\n      done = true;\n      return callback(error);\n    }\n\n    if (++currentPre >= numPres) {\n      if (asyncPresLeft > 0) {\n        // Leave parallel hooks to run\n        return;\n      } else {\n        return callback(null);\n      }\n    }\n\n    next.apply(context, arguments);\n  }\n};\n\nKareem.prototype.execPreSync = function (name, context, args) {\n  var pres = get(this._pres, name, []);\n  var numPres = pres.length;\n\n  for (var i = 0; i < numPres; ++i) {\n    pres[i].fn.apply(context, args || []);\n  }\n};\n\nKareem.prototype.execPost = function (name, context, args, options, callback) {\n  if (arguments.length < 5) {\n    callback = options;\n    options = null;\n  }\n\n  var posts = get(this._posts, name, []);\n  var numPosts = posts.length;\n  var currentPost = 0;\n  var firstError = null;\n\n  if (options && options.error) {\n    firstError = options.error;\n  }\n\n  if (!numPosts) {\n    return process.nextTick(function () {\n      callback.apply(null, [firstError].concat(args));\n    });\n  }\n\n  var next = function () {\n    var post = posts[currentPost].fn;\n    var numArgs = 0;\n    var argLength = args.length;\n    var newArgs = [];\n\n    for (var i = 0; i < argLength; ++i) {\n      numArgs += args[i] && args[i]._kareemIgnore ? 0 : 1;\n\n      if (!args[i] || !args[i]._kareemIgnore) {\n        newArgs.push(args[i]);\n      }\n    }\n\n    if (firstError) {\n      if (post.length === numArgs + 2) {\n        var _cb = decorateNextFn(function (error) {\n          if (error) {\n            firstError = error;\n          }\n\n          if (++currentPost >= numPosts) {\n            return callback.call(null, firstError);\n          }\n\n          next();\n        });\n\n        callMiddlewareFunction(post, context, [firstError].concat(newArgs).concat([_cb]), _cb);\n      } else {\n        if (++currentPost >= numPosts) {\n          return callback.call(null, firstError);\n        }\n\n        next();\n      }\n    } else {\n      const _cb = decorateNextFn(function (error) {\n        if (error) {\n          firstError = error;\n          return next();\n        }\n\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [null].concat(args));\n        }\n\n        next();\n      });\n\n      if (post.length === numArgs + 2) {\n        // Skip error handlers if no error\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [null].concat(args));\n        }\n\n        return next();\n      }\n\n      if (post.length === numArgs + 1) {\n        callMiddlewareFunction(post, context, newArgs.concat([_cb]), _cb);\n      } else {\n        let error;\n        let maybePromise;\n\n        try {\n          maybePromise = post.apply(context, newArgs);\n        } catch (err) {\n          error = err;\n          firstError = err;\n        }\n\n        if (isPromise(maybePromise)) {\n          return maybePromise.then(() => _cb(), err => _cb(err));\n        }\n\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [error].concat(args));\n        }\n\n        next(error);\n      }\n    }\n  };\n\n  next();\n};\n\nKareem.prototype.execPostSync = function (name, context, args) {\n  const posts = get(this._posts, name, []);\n  const numPosts = posts.length;\n\n  for (let i = 0; i < numPosts; ++i) {\n    posts[i].fn.apply(context, args || []);\n  }\n};\n\nKareem.prototype.createWrapperSync = function (name, fn) {\n  var kareem = this;\n  return function syncWrapper() {\n    kareem.execPreSync(name, this, arguments);\n    var toReturn = fn.apply(this, arguments);\n    kareem.execPostSync(name, this, [toReturn]);\n    return toReturn;\n  };\n};\n\nfunction _handleWrapError(instance, error, name, context, args, options, callback) {\n  if (options.useErrorHandlers) {\n    var _options = {\n      error: error\n    };\n    return instance.execPost(name, context, args, _options, function (error) {\n      return typeof callback === 'function' && callback(error);\n    });\n  } else {\n    return typeof callback === 'function' ? callback(error) : undefined;\n  }\n}\n\nKareem.prototype.wrap = function (name, fn, context, args, options) {\n  const lastArg = args.length > 0 ? args[args.length - 1] : null;\n  const argsWithoutCb = typeof lastArg === 'function' ? args.slice(0, args.length - 1) : args;\n\n  const _this = this;\n\n  options = options || {};\n  const checkForPromise = options.checkForPromise;\n  this.execPre(name, context, args, function (error) {\n    if (error) {\n      const numCallbackParams = options.numCallbackParams || 0;\n      const errorArgs = options.contextParameter ? [context] : [];\n\n      for (var i = errorArgs.length; i < numCallbackParams; ++i) {\n        errorArgs.push(null);\n      }\n\n      return _handleWrapError(_this, error, name, context, errorArgs, options, lastArg);\n    }\n\n    const end = typeof lastArg === 'function' ? args.length - 1 : args.length;\n    const numParameters = fn.length;\n    const ret = fn.apply(context, args.slice(0, end).concat(_cb));\n\n    if (checkForPromise) {\n      if (ret != null && typeof ret.then === 'function') {\n        // Thenable, use it\n        return ret.then(res => _cb(null, res), err => _cb(err));\n      } // If `fn()` doesn't have a callback argument and doesn't return a\n      // promise, assume it is sync\n\n\n      if (numParameters < end + 1) {\n        return _cb(null, ret);\n      }\n    }\n\n    function _cb() {\n      const args = arguments;\n      const argsWithoutError = Array.prototype.slice.call(arguments, 1);\n\n      if (options.nullResultByDefault && argsWithoutError.length === 0) {\n        argsWithoutError.push(null);\n      }\n\n      if (arguments[0]) {\n        // Assume error\n        return _handleWrapError(_this, arguments[0], name, context, argsWithoutError, options, lastArg);\n      } else {\n        _this.execPost(name, context, argsWithoutError, function () {\n          if (arguments[0]) {\n            return typeof lastArg === 'function' ? lastArg(arguments[0]) : undefined;\n          }\n\n          return typeof lastArg === 'function' ? lastArg.apply(context, arguments) : undefined;\n        });\n      }\n    }\n  });\n};\n\nKareem.prototype.filter = function (fn) {\n  const clone = this.clone();\n  const pres = Array.from(clone._pres.keys());\n\n  for (const name of pres) {\n    const hooks = this._pres.get(name).map(h => Object.assign({}, h, {\n      name: name\n    })).filter(fn);\n\n    if (hooks.length === 0) {\n      clone._pres.delete(name);\n\n      continue;\n    }\n\n    hooks.numAsync = hooks.filter(h => h.isAsync).length;\n\n    clone._pres.set(name, hooks);\n  }\n\n  const posts = Array.from(clone._posts.keys());\n\n  for (const name of posts) {\n    const hooks = this._posts.get(name).map(h => Object.assign({}, h, {\n      name: name\n    })).filter(fn);\n\n    if (hooks.length === 0) {\n      clone._posts.delete(name);\n\n      continue;\n    }\n\n    clone._posts.set(name, hooks);\n  }\n\n  return clone;\n};\n\nKareem.prototype.hasHooks = function (name) {\n  return this._pres.has(name) || this._posts.has(name);\n};\n\nKareem.prototype.createWrapper = function (name, fn, context, options) {\n  var _this = this;\n\n  if (!this.hasHooks(name)) {\n    // Fast path: if there's no hooks for this function, just return the\n    // function wrapped in a nextTick()\n    return function () {\n      process.nextTick(() => fn.apply(this, arguments));\n    };\n  }\n\n  return function () {\n    var _context = context || this;\n\n    var args = Array.prototype.slice.call(arguments);\n\n    _this.wrap(name, fn, _context, args, options);\n  };\n};\n\nKareem.prototype.pre = function (name, isAsync, fn, error, unshift) {\n  let options = {};\n\n  if (typeof isAsync === 'object' && isAsync != null) {\n    options = isAsync;\n    isAsync = options.isAsync;\n  } else if (typeof arguments[1] !== 'boolean') {\n    error = fn;\n    fn = isAsync;\n    isAsync = false;\n  }\n\n  const pres = get(this._pres, name, []);\n\n  this._pres.set(name, pres);\n\n  if (isAsync) {\n    pres.numAsync = pres.numAsync || 0;\n    ++pres.numAsync;\n  }\n\n  if (typeof fn !== 'function') {\n    throw new Error('pre() requires a function, got \"' + typeof fn + '\"');\n  }\n\n  if (unshift) {\n    pres.unshift(Object.assign({}, options, {\n      fn: fn,\n      isAsync: isAsync\n    }));\n  } else {\n    pres.push(Object.assign({}, options, {\n      fn: fn,\n      isAsync: isAsync\n    }));\n  }\n\n  return this;\n};\n\nKareem.prototype.post = function (name, options, fn, unshift) {\n  const hooks = get(this._posts, name, []);\n\n  if (typeof options === 'function') {\n    unshift = !!fn;\n    fn = options;\n    options = {};\n  }\n\n  if (typeof fn !== 'function') {\n    throw new Error('post() requires a function, got \"' + typeof fn + '\"');\n  }\n\n  if (unshift) {\n    hooks.unshift(Object.assign({}, options, {\n      fn: fn\n    }));\n  } else {\n    hooks.push(Object.assign({}, options, {\n      fn: fn\n    }));\n  }\n\n  this._posts.set(name, hooks);\n\n  return this;\n};\n\nKareem.prototype.clone = function () {\n  const n = new Kareem();\n\n  for (let key of this._pres.keys()) {\n    const clone = this._pres.get(key).slice();\n\n    clone.numAsync = this._pres.get(key).numAsync;\n\n    n._pres.set(key, clone);\n  }\n\n  for (let key of this._posts.keys()) {\n    n._posts.set(key, this._posts.get(key).slice());\n  }\n\n  return n;\n};\n\nKareem.prototype.merge = function (other, clone) {\n  clone = arguments.length === 1 ? true : clone;\n  var ret = clone ? this.clone() : this;\n\n  for (let key of other._pres.keys()) {\n    const sourcePres = get(ret._pres, key, []);\n\n    const deduplicated = other._pres.get(key). // Deduplicate based on `fn`\n    filter(p => sourcePres.map(_p => _p.fn).indexOf(p.fn) === -1);\n\n    const combined = sourcePres.concat(deduplicated);\n    combined.numAsync = sourcePres.numAsync || 0;\n    combined.numAsync += deduplicated.filter(p => p.isAsync).length;\n\n    ret._pres.set(key, combined);\n  }\n\n  for (let key of other._posts.keys()) {\n    const sourcePosts = get(ret._posts, key, []);\n\n    const deduplicated = other._posts.get(key).filter(p => sourcePosts.indexOf(p) === -1);\n\n    ret._posts.set(key, sourcePosts.concat(deduplicated));\n  }\n\n  return ret;\n};\n\nfunction get(map, key, def) {\n  if (map.has(key)) {\n    return map.get(key);\n  }\n\n  return def;\n}\n\nfunction callMiddlewareFunction(fn, context, args, next) {\n  let maybePromise;\n\n  try {\n    maybePromise = fn.apply(context, args);\n  } catch (error) {\n    return next(error);\n  }\n\n  if (isPromise(maybePromise)) {\n    maybePromise.then(() => next(), err => next(err));\n  }\n}\n\nfunction isPromise(v) {\n  return v != null && typeof v.then === 'function';\n}\n\nfunction decorateNextFn(fn) {\n  var called = false;\n\n  var _this = this;\n\n  return function () {\n    // Ensure this function can only be called once\n    if (called) {\n      return;\n    }\n\n    called = true; // Make sure to clear the stack so try/catch doesn't catch errors\n    // in subsequent middleware\n\n    return process.nextTick(() => fn.apply(_this, arguments));\n  };\n}\n\nmodule.exports = Kareem;","map":{"version":3,"sources":["/home/gregorian/calendar-ui/node_modules/kareem/index.js"],"names":["Kareem","_pres","Map","_posts","prototype","execPre","name","context","args","callback","arguments","length","pres","get","numPres","numAsyncPres","numAsync","currentPre","asyncPresLeft","done","$args","process","nextTick","next","pre","isAsync","decorateNextFn","_next","error","callMiddlewareFunction","fn","_args","concat","i","push","maybePromise","call","err","isPromise","then","apply","execPreSync","execPost","options","posts","numPosts","currentPost","firstError","post","numArgs","argLength","newArgs","_kareemIgnore","_cb","execPostSync","createWrapperSync","kareem","syncWrapper","toReturn","_handleWrapError","instance","useErrorHandlers","_options","undefined","wrap","lastArg","argsWithoutCb","slice","_this","checkForPromise","numCallbackParams","errorArgs","contextParameter","end","numParameters","ret","res","argsWithoutError","Array","nullResultByDefault","filter","clone","from","keys","hooks","map","h","Object","assign","delete","set","hasHooks","has","createWrapper","_context","unshift","Error","n","key","merge","other","sourcePres","deduplicated","p","_p","indexOf","combined","sourcePosts","def","v","called","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nfunction Kareem() {\n  this._pres = new Map();\n  this._posts = new Map();\n}\n\nKareem.prototype.execPre = function(name, context, args, callback) {\n  if (arguments.length === 3) {\n    callback = args;\n    args = [];\n  }\n  var pres = get(this._pres, name, []);\n  var numPres = pres.length;\n  var numAsyncPres = pres.numAsync || 0;\n  var currentPre = 0;\n  var asyncPresLeft = numAsyncPres;\n  var done = false;\n  var $args = args;\n\n  if (!numPres) {\n    return process.nextTick(function() {\n      callback(null);\n    });\n  }\n\n  var next = function() {\n    if (currentPre >= numPres) {\n      return;\n    }\n    var pre = pres[currentPre];\n\n    if (pre.isAsync) {\n      var args = [\n        decorateNextFn(_next),\n        decorateNextFn(function(error) {\n          if (error) {\n            if (done) {\n              return;\n            }\n            done = true;\n            return callback(error);\n          }\n          if (--asyncPresLeft === 0 && currentPre >= numPres) {\n            return callback(null);\n          }\n        })\n      ];\n\n      callMiddlewareFunction(pre.fn, context, args, args[0]);\n    } else if (pre.fn.length > 0) {\n      var args = [decorateNextFn(_next)];\n      var _args = arguments.length >= 2 ? arguments : [null].concat($args);\n      for (var i = 1; i < _args.length; ++i) {\n        args.push(_args[i]);\n      }\n\n      callMiddlewareFunction(pre.fn, context, args, args[0]);\n    } else {\n      let maybePromise = null;\n      try {\n        maybePromise = pre.fn.call(context);\n      } catch (err) {\n        if (err != null) {\n          return callback(err);\n        }\n      }\n\n      if (isPromise(maybePromise)) {\n        maybePromise.then(() => _next(), err => _next(err));\n      } else {\n        if (++currentPre >= numPres) {\n          if (asyncPresLeft > 0) {\n            // Leave parallel hooks to run\n            return;\n          } else {\n            return process.nextTick(function() {\n              callback(null);\n            });\n          }\n        }\n        next();\n      }\n    }\n  };\n\n  next.apply(null, [null].concat(args));\n\n  function _next(error) {\n    if (error) {\n      if (done) {\n        return;\n      }\n      done = true;\n      return callback(error);\n    }\n\n    if (++currentPre >= numPres) {\n      if (asyncPresLeft > 0) {\n        // Leave parallel hooks to run\n        return;\n      } else {\n        return callback(null);\n      }\n    }\n\n    next.apply(context, arguments);\n  }\n};\n\nKareem.prototype.execPreSync = function(name, context, args) {\n  var pres = get(this._pres, name, []);\n  var numPres = pres.length;\n\n  for (var i = 0; i < numPres; ++i) {\n    pres[i].fn.apply(context, args || []);\n  }\n};\n\nKareem.prototype.execPost = function(name, context, args, options, callback) {\n  if (arguments.length < 5) {\n    callback = options;\n    options = null;\n  }\n  var posts = get(this._posts, name, []);\n  var numPosts = posts.length;\n  var currentPost = 0;\n\n  var firstError = null;\n  if (options && options.error) {\n    firstError = options.error;\n  }\n\n  if (!numPosts) {\n    return process.nextTick(function() {\n      callback.apply(null, [firstError].concat(args));\n    });\n  }\n\n  var next = function() {\n    var post = posts[currentPost].fn;\n    var numArgs = 0;\n    var argLength = args.length;\n    var newArgs = [];\n    for (var i = 0; i < argLength; ++i) {\n      numArgs += args[i] && args[i]._kareemIgnore ? 0 : 1;\n      if (!args[i] || !args[i]._kareemIgnore) {\n        newArgs.push(args[i]);\n      }\n    }\n\n    if (firstError) {\n      if (post.length === numArgs + 2) {\n        var _cb = decorateNextFn(function(error) {\n          if (error) {\n            firstError = error;\n          }\n          if (++currentPost >= numPosts) {\n            return callback.call(null, firstError);\n          }\n          next();\n        });\n\n        callMiddlewareFunction(post, context,\n          [firstError].concat(newArgs).concat([_cb]), _cb);\n      } else {\n        if (++currentPost >= numPosts) {\n          return callback.call(null, firstError);\n        }\n        next();\n      }\n    } else {\n      const _cb = decorateNextFn(function(error) {\n        if (error) {\n          firstError = error;\n          return next();\n        }\n\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [null].concat(args));\n        }\n\n        next();\n      });\n\n      if (post.length === numArgs + 2) {\n        // Skip error handlers if no error\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [null].concat(args));\n        }\n        return next();\n      }\n      if (post.length === numArgs + 1) {\n        callMiddlewareFunction(post, context, newArgs.concat([_cb]), _cb);\n      } else {\n        let error;\n        let maybePromise;\n        try {\n          maybePromise = post.apply(context, newArgs);\n        } catch (err) {\n          error = err;\n          firstError = err;\n        }\n\n        if (isPromise(maybePromise)) {\n          return maybePromise.then(() => _cb(), err => _cb(err));\n        }\n\n        if (++currentPost >= numPosts) {\n          return callback.apply(null, [error].concat(args));\n        }\n\n        next(error);\n      }\n    }\n  };\n\n  next();\n};\n\nKareem.prototype.execPostSync = function(name, context, args) {\n  const posts = get(this._posts, name, []);\n  const numPosts = posts.length;\n\n  for (let i = 0; i < numPosts; ++i) {\n    posts[i].fn.apply(context, args || []);\n  }\n};\n\nKareem.prototype.createWrapperSync = function(name, fn) {\n  var kareem = this;\n  return function syncWrapper() {\n    kareem.execPreSync(name, this, arguments);\n\n    var toReturn = fn.apply(this, arguments);\n\n    kareem.execPostSync(name, this, [toReturn]);\n\n    return toReturn;\n  };\n}\n\nfunction _handleWrapError(instance, error, name, context, args, options, callback) {\n  if (options.useErrorHandlers) {\n    var _options = { error: error };\n    return instance.execPost(name, context, args, _options, function(error) {\n      return typeof callback === 'function' && callback(error);\n    });\n  } else {\n    return typeof callback === 'function' ?\n      callback(error) :\n      undefined;\n  }\n}\n\nKareem.prototype.wrap = function(name, fn, context, args, options) {\n  const lastArg = (args.length > 0 ? args[args.length - 1] : null);\n  const argsWithoutCb = typeof lastArg === 'function' ?\n    args.slice(0, args.length - 1) :\n    args;\n  const _this = this;\n\n  options = options || {};\n  const checkForPromise = options.checkForPromise;\n\n  this.execPre(name, context, args, function(error) {\n    if (error) {\n      const numCallbackParams = options.numCallbackParams || 0;\n      const errorArgs = options.contextParameter ? [context] : [];\n      for (var i = errorArgs.length; i < numCallbackParams; ++i) {\n        errorArgs.push(null);\n      }\n      return _handleWrapError(_this, error, name, context, errorArgs,\n        options, lastArg);\n    }\n\n    const end = (typeof lastArg === 'function' ? args.length - 1 : args.length);\n    const numParameters = fn.length;\n    const ret = fn.apply(context, args.slice(0, end).concat(_cb));\n\n    if (checkForPromise) {\n      if (ret != null && typeof ret.then === 'function') {\n        // Thenable, use it\n        return ret.then(\n          res => _cb(null, res),\n          err => _cb(err)\n        );\n      }\n\n      // If `fn()` doesn't have a callback argument and doesn't return a\n      // promise, assume it is sync\n      if (numParameters < end + 1) {\n        return _cb(null, ret);\n      }\n    }\n\n    function _cb() {\n      const args = arguments;\n      const argsWithoutError = Array.prototype.slice.call(arguments, 1);\n      if (options.nullResultByDefault && argsWithoutError.length === 0) {\n        argsWithoutError.push(null);\n      }\n      if (arguments[0]) {\n        // Assume error\n        return _handleWrapError(_this, arguments[0], name, context,\n          argsWithoutError, options, lastArg);\n      } else {\n        _this.execPost(name, context, argsWithoutError, function() {\n          if (arguments[0]) {\n            return typeof lastArg === 'function' ?\n              lastArg(arguments[0]) :\n              undefined;\n          }\n\n          return typeof lastArg === 'function' ?\n            lastArg.apply(context, arguments) :\n            undefined;\n        });\n      }\n    }\n  });\n};\n\nKareem.prototype.filter = function(fn) {\n  const clone = this.clone();\n\n  const pres = Array.from(clone._pres.keys());\n  for (const name of pres) {\n    const hooks = this._pres.get(name).\n      map(h => Object.assign({}, h, { name: name })).\n      filter(fn);\n\n    if (hooks.length === 0) {\n      clone._pres.delete(name);\n      continue;\n    }\n\n    hooks.numAsync = hooks.filter(h => h.isAsync).length;\n\n    clone._pres.set(name, hooks);\n  }\n\n  const posts = Array.from(clone._posts.keys());\n  for (const name of posts) {\n    const hooks = this._posts.get(name).\n      map(h => Object.assign({}, h, { name: name })).\n      filter(fn);\n\n    if (hooks.length === 0) {\n      clone._posts.delete(name);\n      continue;\n    }\n\n    clone._posts.set(name, hooks);\n  }\n\n  return clone;\n};\n\nKareem.prototype.hasHooks = function(name) {\n  return this._pres.has(name) || this._posts.has(name);\n};\n\nKareem.prototype.createWrapper = function(name, fn, context, options) {\n  var _this = this;\n  if (!this.hasHooks(name)) {\n    // Fast path: if there's no hooks for this function, just return the\n    // function wrapped in a nextTick()\n    return function() {\n      process.nextTick(() => fn.apply(this, arguments));\n    };\n  }\n  return function() {\n    var _context = context || this;\n    var args = Array.prototype.slice.call(arguments);\n    _this.wrap(name, fn, _context, args, options);\n  };\n};\n\nKareem.prototype.pre = function(name, isAsync, fn, error, unshift) {\n  let options = {};\n  if (typeof isAsync === 'object' && isAsync != null) {\n    options = isAsync;\n    isAsync = options.isAsync;\n  } else if (typeof arguments[1] !== 'boolean') {\n    error = fn;\n    fn = isAsync;\n    isAsync = false;\n  }\n\n  const pres = get(this._pres, name, []);\n  this._pres.set(name, pres);\n\n  if (isAsync) {\n    pres.numAsync = pres.numAsync || 0;\n    ++pres.numAsync;\n  }\n\n  if (typeof fn !== 'function') {\n    throw new Error('pre() requires a function, got \"' + typeof fn + '\"');\n  }\n\n  if (unshift) {\n    pres.unshift(Object.assign({}, options, { fn: fn, isAsync: isAsync }));\n  } else {\n    pres.push(Object.assign({}, options, { fn: fn, isAsync: isAsync }));\n  }\n\n  return this;\n};\n\nKareem.prototype.post = function(name, options, fn, unshift) {\n  const hooks = get(this._posts, name, []);\n\n  if (typeof options === 'function') {\n    unshift = !!fn;\n    fn = options;\n    options = {};\n  }\n\n  if (typeof fn !== 'function') {\n    throw new Error('post() requires a function, got \"' + typeof fn + '\"');\n  }\n\n  if (unshift) {\n    hooks.unshift(Object.assign({}, options, { fn: fn }));\n  } else {\n    hooks.push(Object.assign({}, options, { fn: fn }));\n  }\n  this._posts.set(name, hooks);\n  return this;\n};\n\nKareem.prototype.clone = function() {\n  const n = new Kareem();\n\n  for (let key of this._pres.keys()) {\n    const clone = this._pres.get(key).slice();\n    clone.numAsync = this._pres.get(key).numAsync;\n    n._pres.set(key, clone);\n  }\n  for (let key of this._posts.keys()) {\n    n._posts.set(key, this._posts.get(key).slice());\n  }\n\n  return n;\n};\n\nKareem.prototype.merge = function(other, clone) {\n  clone = arguments.length === 1 ? true : clone;\n  var ret = clone ? this.clone() : this;\n\n  for (let key of other._pres.keys()) {\n    const sourcePres = get(ret._pres, key, []);\n    const deduplicated = other._pres.get(key).\n      // Deduplicate based on `fn`\n      filter(p => sourcePres.map(_p => _p.fn).indexOf(p.fn) === -1);\n    const combined = sourcePres.concat(deduplicated);\n    combined.numAsync = sourcePres.numAsync || 0;\n    combined.numAsync += deduplicated.filter(p => p.isAsync).length;\n    ret._pres.set(key, combined);\n  }\n  for (let key of other._posts.keys()) {\n    const sourcePosts = get(ret._posts, key, []);\n    const deduplicated = other._posts.get(key).\n      filter(p => sourcePosts.indexOf(p) === -1);\n    ret._posts.set(key, sourcePosts.concat(deduplicated));\n  }\n\n  return ret;\n};\n\nfunction get(map, key, def) {\n  if (map.has(key)) {\n    return map.get(key);\n  }\n  return def;\n}\n\nfunction callMiddlewareFunction(fn, context, args, next) {\n  let maybePromise;\n  try {\n    maybePromise = fn.apply(context, args);\n  } catch (error) {\n    return next(error);\n  }\n\n  if (isPromise(maybePromise)) {\n    maybePromise.then(() => next(), err => next(err));\n  }\n}\n\nfunction isPromise(v) {\n  return v != null && typeof v.then === 'function';\n}\n\nfunction decorateNextFn(fn) {\n  var called = false;\n  var _this = this;\n  return function() {\n    // Ensure this function can only be called once\n    if (called) {\n      return;\n    }\n    called = true;\n    // Make sure to clear the stack so try/catch doesn't catch errors\n    // in subsequent middleware\n    return process.nextTick(() => fn.apply(_this, arguments));\n  };\n}\n\nmodule.exports = Kareem;\n"]},"metadata":{},"sourceType":"script"}